name: ğŸ€ Basketball Club Crawler (Quarterly)

on:
  # Scheduled: Quartalsweise am 1. um 02:00 UTC
  # Januar, April, Juli, Oktober
  schedule:
    - cron: '0 2 1 1,4,7,10 *'
  
  # Manuell ausfÃ¼hrbar
  workflow_dispatch:

jobs:
  crawl:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: basketball-app/package-lock.json
      
      - name: ğŸ“¦ Install Dependencies
        working-directory: basketball-app
        run: npm ci
      
      - name: ğŸ—‚ï¸ Create Backup
        working-directory: basketball-app
        run: |
          if [ -f "src/shared/data/clubs-germany.json" ]; then
            mkdir -p ../backups
            TIMESTAMP=$(date +%Y%m%d-%H%M%S)
            cp src/shared/data/clubs-germany.json ../backups/clubs-germany-$TIMESTAMP.json
            echo "âœ… Backup erstellt: clubs-germany-$TIMESTAMP.json"
          fi
      
      - name: ğŸ€ Run Crawler (ALL VerbÃ¤nde)
        working-directory: basketball-app
        run: npm run crawl:clubs:all
      
      - name: ğŸ“Š Check Output
        working-directory: basketball-app
        run: |
          if [ -f "src/shared/data/clubs-germany.json" ]; then
            echo "ğŸ“ Output-Datei vorhanden"
            FILE_SIZE=$(du -h src/shared/data/clubs-germany.json | cut -f1)
            echo "ğŸ“¦ GrÃ¶ÃŸe: $FILE_SIZE"
            
            if command -v jq &> /dev/null; then
              echo "ğŸ“‹ Metadata:"
              jq '.metadata' src/shared/data/clubs-germany.json
            fi
          else
            echo "âŒ Keine Output-Datei gefunden!"
            exit 1
          fi
      
      - name: ğŸ’¾ Upload Artifact (Backup)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: clubs-germany-backup-${{ github.run_number }}
          path: |
            basketball-app/src/shared/data/clubs-germany.json
            backups/*.json
          retention-days: 90
      
      - name: ğŸ“ Commit & Push Changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add basketball-app/src/shared/data/clubs-germany.json
          
          if git diff --staged --quiet; then
            echo "âœ… Keine Ã„nderungen - Skip Commit"
          else
            QUARTER=$(date +%Y-Q$((($(date +%-m)-1)/3+1)))
            git commit -m "chore: Update Club-Daten ($QUARTER) [skip ci]"
            git push
            echo "âœ… Ã„nderungen committed und gepusht"
          fi
      
      - name: ğŸ“§ Notification on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'âŒ Basketball Crawler (Quarterly) fehlgeschlagen',
              body: `Der quartalsweise Crawler-Lauf ist fehlgeschlagen.\n\n**Run:** ${runUrl}\n**Datum:** ${new Date().toISOString()}\n\nBitte Logs prÃ¼fen.`,
              labels: ['automation', 'bug']
            });
